---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieBanner from '../components/CookieBanner.astro';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  image?: string;
  canonical?: string;
  type?: 'website' | 'article';
  noindex?: boolean;
  currentPage?: string;
  schema?: object;
  breadcrumbs?: Array<{ name: string; url: string }>;
  keywords?: string;
}

const {
  title,
  description,
  image = '/og-image.svg',
  canonical,
  type = 'website',
  noindex = false,
  currentPage = 'home',
  schema,
  breadcrumbs,
  keywords = 'MLM, marketing multi-niveau, système MLM, parrainage, affiliation, commission, réseau, entreprise, automatisation, plan de rémunération'
} = Astro.props;

const siteUrl = 'https://tousgether.com';
const canonicalUrl = canonical || new URL(Astro.url.pathname, siteUrl).href;
const ogImageUrl = new URL(image, siteUrl).href;

// Schema par défaut si non fourni
const defaultSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Tousgether",
  "description": "Expert en création et déploiement de systèmes MLM digitaux pour les entreprises",
  "url": siteUrl,
  "logo": `${siteUrl}/favicon.svg`,
  "foundingDate": "2023",
  "sameAs": [
    "https://www.linkedin.com/company/tousgether"
  ],
  "contactPoint": {
    "@type": "ContactPoint",
    "email": "contact@tousgether.com",
    "contactType": "customer service",
    "availableLanguage": "French"
  },
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "6 rue Rose Dieng-Kuntz",
    "postalCode": "44300",
    "addressLocality": "Nantes",
    "addressCountry": "FR"
  }
};

const finalSchema = schema || defaultSchema;

// Breadcrumb schema
const breadcrumbSchema = breadcrumbs ? {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbs.map((item, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": item.name,
    "item": item.url.startsWith('http') ? item.url : `${siteUrl}${item.url}`
  }))
} : null;
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  
  <!-- Performance: DNS Prefetch & Preconnect -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Critical CSS Inline for font-display -->
  <style>
    @font-face {
      font-family: 'Outfit';
      font-style: normal;
      font-weight: 400 700;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/outfit/v11/QGYyz_MVcBeNP4NjuGObqx1XmO1I4TC1C4a-.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  
  <!-- Load full font asynchronously -->
  <link 
    rel="preload" 
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" 
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  >
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  </noscript>
  
  <!-- SEO Meta Tags -->
  <title>{title}</title>
  <meta name="description" content={description}>
  <meta name="keywords" content={keywords}>
  <meta name="author" content="Tousgether">
  <meta name="generator" content="Astro">
  <meta name="language" content="French">
  <meta name="revisit-after" content="7 days">
  <meta name="coverage" content="France">
  <meta name="distribution" content="global">
  <meta name="rating" content="general">
  
  {noindex ? (
    <meta name="robots" content="noindex, nofollow">
  ) : (
    <>
      <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
      <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
      <meta name="bingbot" content="index, follow">
    </>
  )}
  <link rel="canonical" href={canonicalUrl}>
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content={type}>
  <meta property="og:url" content={canonicalUrl}>
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  <meta property="og:image" content={ogImageUrl}>
  <meta property="og:image:alt" content="Tousgether - Solution MLM pour entreprises">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:locale" content="fr_FR">
  <meta property="og:site_name" content="Tousgether">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content={canonicalUrl}>
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={description}>
  <meta name="twitter:image" content={ogImageUrl}>
  <meta name="twitter:image:alt" content="Tousgether - Solution MLM pour entreprises">
  
  <!-- Favicon & Theme -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#803B85" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#803B85" media="(prefers-color-scheme: dark)">
  <meta name="msapplication-TileColor" content="#803B85">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tousgether">
  
  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- Schema.org Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(finalSchema)} />
  {breadcrumbSchema && <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />}
  
  <!-- Resource hints for better performance -->
  <link rel="prerender" href="/devis">
  
  <slot name="head" />
</head>
<body>
  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="skip-link">Aller au contenu principal</a>
  
  <Header currentPage={currentPage} />
  
  <main id="main-content" role="main">
    <slot />
  </main>
  
  <Footer />
  
  <CookieBanner />
  
  <!-- Intersection Observer fallback for older browsers -->
  <script>
    // Only run if scroll-driven animations are not supported
    if (!CSS.supports('animation-timeline', 'scroll()')) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('animated');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
      
      document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
    }
  </script>
</body>
</html>

<style is:global>
  .skip-link {
    position: absolute;
    top: -100px;
    left: 50%;
    transform: translateX(-50%);
    background: #803B85;
    color: white;
    padding: 12px 24px;
    border-radius: 980px;
    font-weight: 600;
    z-index: 9999;
    transition: top 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
    text-decoration: none;
  }

  .skip-link:focus {
    top: 20px;
    outline: 2px solid white;
    outline-offset: 2px;
  }
</style>
